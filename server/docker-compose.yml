# =============================================================================
# L-File Usogui Fansite - Development Docker Compose
# =============================================================================
# Usage:
#   docker-compose up        - Start the server with hot reload
#   docker-compose up -d     - Start in detached mode
#   docker-compose down      - Stop all services
#   docker-compose logs -f   - Follow logs
#   docker-compose --profile migrations up migrations  - Run migrations
# =============================================================================

services:
  server:
    build:
      context: .
      dockerfile: Dockerfile
      target: deps
    container_name: usogui-server-dev
    restart: unless-stopped

    # Override to use ts-node with hot reload for development
    command: yarn start:dev

    # Mount source code for hot reload
    volumes:
      - .:/app
      - /app/node_modules

    ports:
      - "3001:3001"
      - "9229:9229"

    environment:
      - NODE_ENV=development
      - PORT=3001
      # Database - Supabase connection (loaded from .env)
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - DATABASE_USERNAME=${DATABASE_USERNAME}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_SSL=${DATABASE_SSL:-true}
      # JWT
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES=${JWT_EXPIRES}
      # Discord OAuth
      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
      - DISCORD_CLIENT_SECRET=${DISCORD_CLIENT_SECRET}
      - DISCORD_CALLBACK_URL=${DISCORD_CALLBACK_URL}
      - ADMIN_DISCORD_ID=${ADMIN_DISCORD_ID}
      # Frontend
      - FRONTEND_URL=${FRONTEND_URL}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-}
      # Email
      - RESEND_API_KEY=${RESEND_API_KEY}
      # Backblaze B2
      - B2_APPLICATION_KEY_ID=${B2_APPLICATION_KEY_ID:-}
      - B2_APPLICATION_KEY=${B2_APPLICATION_KEY:-}
      - B2_BUCKET_NAME=${B2_BUCKET_NAME:-}
      - B2_BUCKET_ID=${B2_BUCKET_ID:-}
      # Database Safety
      - ENABLE_SCHEMA_SYNC=${ENABLE_SCHEMA_SYNC:-false}
      - RUN_MIGRATIONS=${RUN_MIGRATIONS:-false}

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    networks:
      - usogui-network

  # Migration runner service (run with --profile migrations)
  migrations:
    build:
      context: .
      dockerfile: Dockerfile
      target: builder
    container_name: usogui-migrations
    profiles:
      - migrations

    command: yarn db:migrate

    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - DATABASE_HOST=${DATABASE_HOST}
      - DATABASE_PORT=${DATABASE_PORT}
      - DATABASE_USERNAME=${DATABASE_USERNAME}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      - DATABASE_NAME=${DATABASE_NAME}
      - DATABASE_SSL=${DATABASE_SSL:-true}

    networks:
      - usogui-network

networks:
  usogui-network:
    driver: bridge
